FROM python:2.7
MAINTAINER John Flavin <jflavin@wustl.edu>

RUN apt-get update && apt-get install -y \
        curl \
        mercurial \
        pigz \
        zip \
        && \
    pip install \
        dicom \
        nipype \
        requests \
        && \
    rm -r ${HOME}/.cache/pip && \
    curl -L https://github.com/rordenlab/dcm2niix/releases/download/v1.0.20180622/dcm2niix_27-Jun-2018_lnx.zip  > dcm2niix.zip && \
    unzip dcm2niix.zip && \
    mv dcm2niix /usr/local/bin && \
    chmod a+x /usr/local/bin/dcm2niix && \
    rm dcm* && \
    apt-get remove -y \
        curl \
        mercurial \
        zip \
        && \
    apt-get autoremove -y && \
    apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

#COPY nrg_pipeline_dicomtobids/scripts/catalog/DicomToBIDS/scripts/dcm2bids_wholeSession.py /src/dcm2bids_wholeSession.py
COPY dcm2bids_wholeSession.py /src/dcm2bids_wholeSession.py
COPY xnatSession.py /src/xnatSession.py

WORKDIR /src

LABEL org.nrg.commands="[{\"name\": \"dcm2bids\", \"description\": \"Runs dcm2niix on a session's scans, and uploads the nifti and bids json\", \"version\": \"2.1\", \"schema-version\": \"1.0\", \"image\": \"radiologicskate/dcm2bids-session:2.1\", \"type\": \"docker\", \"command-line\": \"python dcm2bids_wholeSession.py #SESSION_ID# #SESSION_LABEL# #SUBJECT# #PROJECT# #OVERWRITE# #SKIP# --host \$XNAT_HOST --user \$XNAT_USER --pass \$XNAT_PASS --upload-by-ref False --dicomdir /dicom --niftidir /nifti\", \"override-entrypoint\": true, \"mounts\": [{\"name\": \"nifti\", \"writable\": true, \"path\": \"/nifti\"}, {\"name\": \"input\", \"writable\": false, \"path\": \"#SESSION_DIR#\"}], \"environment-variables\": {}, \"ports\": {}, \"inputs\": [{\"name\": \"session_id\", \"label\": null, \"description\": \"XNAT ID of the session\", \"type\": \"string\", \"matcher\": null, \"default-value\": null, \"required\": true, \"replacement-key\": \"#SESSION_ID#\", \"sensitive\": null, \"command-line-flag\": \"--session\", \"command-line-separator\": null, \"true-value\": null, \"false-value\": null, \"select-values\": [], \"multiple-delimiter\": null}, {\"name\": \"overwrite\", \"label\": null, \"description\": \"Overwrite any existing NIFTI and BIDS scan resources?\", \"type\": \"boolean\", \"matcher\": null, \"default-value\": \"false\", \"required\": false, \"replacement-key\": \"#OVERWRITE#\", \"sensitive\": null, \"command-line-flag\": \"--overwrite\", \"command-line-separator\": null, \"true-value\": \"True\", \"false-value\": \"False\", \"select-values\": [], \"multiple-delimiter\": null}, {\"name\": \"session_label\", \"label\": null, \"description\": \"Session\", \"type\": \"string\", \"matcher\": null, \"default-value\": null, \"required\": true, \"replacement-key\": \"#SESSION_LABEL#\", \"sensitive\": null, \"command-line-flag\": \"--sessionLabel\", \"command-line-separator\": null, \"true-value\": null, \"false-value\": null, \"select-values\": [], \"multiple-delimiter\": null}, {\"name\": \"project\", \"label\": null, \"description\": \"Project\", \"type\": \"string\", \"matcher\": null, \"default-value\": null, \"required\": true, \"replacement-key\": \"#PROJECT#\", \"sensitive\": null, \"command-line-flag\": \"--project\", \"command-line-separator\": null, \"true-value\": null, \"false-value\": null, \"select-values\": [], \"multiple-delimiter\": null}, {\"name\": \"subject_label\", \"label\": null, \"description\": \"Subject\", \"type\": \"string\", \"matcher\": null, \"default-value\": null, \"required\": true, \"replacement-key\": \"#SUBJECT#\", \"sensitive\": null, \"command-line-flag\": \"--subject\", \"command-line-separator\": null, \"true-value\": null, \"false-value\": null, \"select-values\": [], \"multiple-delimiter\": null}, {\"name\": \"skipUnusable\", \"label\": null, \"description\": \"Skip BIDS conversion of unusable scans?\", \"type\": \"boolean\", \"matcher\": null, \"default-value\": \"false\", \"required\": false, \"replacement-key\": \"#SKIP#\", \"sensitive\": null, \"command-line-flag\": \"--skipUnusable\", \"command-line-separator\": null, \"true-value\": \"True\", \"false-value\": \"False\", \"select-values\": [], \"multiple-delimiter\": null}], \"outputs\": [], \"xnat\": [{\"name\": \"dcm2bids-session\", \"label\": null, \"description\": \"Run dcm2bids on a Session\", \"contexts\": [\"xnat:imageSessionData\"], \"external-inputs\": [{\"name\": \"session\", \"label\": null, \"description\": \"Input session\", \"type\": \"Session\", \"matcher\": null, \"default-value\": null, \"required\": true, \"replacement-key\": null, \"sensitive\": null, \"provides-value-for-command-input\": null, \"provides-files-for-command-mount\": \"input\", \"via-setup-command\": null, \"user-settable\": null, \"load-children\": true}], \"derived-inputs\": [{\"name\": \"session-id\", \"label\": null, \"description\": \"The session's id\", \"type\": \"string\", \"matcher\": null, \"default-value\": null, \"required\": true, \"replacement-key\": null, \"sensitive\": null, \"provides-value-for-command-input\": \"session_id\", \"provides-files-for-command-mount\": null, \"user-settable\": null, \"load-children\": true, \"derived-from-wrapper-input\": \"session\", \"derived-from-xnat-object-property\": \"id\", \"via-setup-command\": null, \"multiple\": false}, {\"name\": \"session-label\", \"label\": null, \"description\": \"The session's label\", \"type\": \"string\", \"matcher\": null, \"default-value\": null, \"required\": true, \"replacement-key\": null, \"sensitive\": null, \"provides-value-for-command-input\": \"session_label\", \"provides-files-for-command-mount\": null, \"user-settable\": null, \"load-children\": true, \"derived-from-wrapper-input\": \"session\", \"derived-from-xnat-object-property\": \"label\", \"via-setup-command\": null, \"multiple\": false}, {\"name\": \"subject-label\", \"label\": null, \"description\": \"The subject label\", \"type\": \"Subject\", \"matcher\": null, \"default-value\": null, \"required\": true, \"replacement-key\": null, \"sensitive\": null, \"provides-value-for-command-input\": \"subject_label\", \"provides-files-for-command-mount\": null, \"user-settable\": null, \"load-children\": true, \"derived-from-wrapper-input\": \"session\", \"derived-from-xnat-object-property\": \"label\", \"via-setup-command\": null, \"multiple\": false}, {\"name\": \"project-id\", \"label\": null, \"description\": \"The project\", \"type\": \"Project\", \"matcher\": null, \"default-value\": null, \"required\": true, \"replacement-key\": null, \"sensitive\": null, \"provides-value-for-command-input\": \"project\", \"provides-files-for-command-mount\": null, \"user-settable\": null, \"load-children\": true, \"derived-from-wrapper-input\": \"session\", \"derived-from-xnat-object-property\": \"id\", \"via-setup-command\": null, \"multiple\": false}, {\"name\": \"session-dir\", \"label\": null, \"description\": \"The session's archive dir\", \"type\": \"string\", \"matcher\": null, \"default-value\": null, \"required\": true, \"replacement-key\": \"#SESSION_DIR#\", \"sensitive\": null, \"provides-value-for-command-input\": null, \"provides-files-for-command-mount\": null, \"user-settable\": false, \"load-children\": true, \"derived-from-wrapper-input\": \"session\", \"derived-from-xnat-object-property\": \"directory\", \"via-setup-command\": null, \"multiple\": false}], \"output-handlers\": []}]}]"
